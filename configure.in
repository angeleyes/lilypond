dnl -*-shell-script-*-
dnl  Process this file with autoconf to produce a configure script. 

dnl should cache result.
dnl should  look in $prefix first.

AC_DEFUN(AC_TEX_PREFIX, [
    

    AC_MSG_CHECKING(TeX/MF root dir directory)    

    find_root_prefix="$prefix"
    

    test "x$find_root_prefix" = xNONE && find_root_prefix="$ac_default_prefix"
    find_texpostfix="";
    for postfix in "/lib/tex/" "/lib/texmf" "/lib" "/tex" "/texmf"; do
	find_texprefix="$find_root_prefix$postfix"
	if test -d $find_texprefix; then
	    find_texpostfix=$postfix
	    break;
	fi
    done
    
    if test "x$find_texpostfix" = x; then
	find_texpostfix='/lib/texmf/tex'
	AC_MSG_WARN(Cannot determine the TeX-directory. Please use --enable-tex-prefix)
    fi

    find_texprefix="$find_root_prefix/$find_texpostfix"
    $1='${prefix}'/"$find_texpostfix"

    AC_MSG_RESULT($find_texprefix)

])

AC_DEFUN(AC_TEX_SUBDIR, [

    # do something sensible if root hasn't specced dir yet attempts install
     test "x$find_texprefix" != x || find_texprefix="$TEXPREFIX"

    AC_MSG_CHECKING(TeX tex input directory)    
    find_texdir=`(cd $find_texprefix; 
      $FIND -type d -a -name tex -print |sort|head -1|sed 's#^\./##')`
    

    if test "x$find_texdir" = x; then
       find_texdir="/tex";
       AC_MSG_WARN(Cannot determine the TeX-subdirectory. Please use --enable-tex-dir)
	true
    fi
    
    $1="$TEXPREFIX/$find_texdir"
    
    AC_MSG_RESULT($find_texprefix/$find_texdir)

])

AC_INIT(flower/choleski.cc)


AC_LANG_CPLUSPLUS
printing_b=no
checking_b=yes
debug_b=yes
optimise_b=no
profile_b=no
#shared_b=no

AC_ARG_ENABLE(printing,
    [  enable-printing        set debug printing],
    [printing_b=$enableval])

	
AC_ARG_ENABLE(checking,
    [  disable-checking       set runtime checks],
    [checking_b=$enableval] )



AC_ARG_ENABLE(debug,
    [  disable-debug          set debug info],
    [debug_b=$enableval])

AC_ARG_ENABLE(optimise,
    [  enable-optimise       use maximal speed optimisations],
    [optimise_b=$enableval])
    
   
AC_ARG_ENABLE(profiling, 
    [  enable-profiling      compile with gprof support],
    [profile_b=$enableval])
    
AC_ARG_ENABLE(tex-prefix,
    [  tex-prefix=DIR  set the tex-directory to find TeX subdirectories.],
    [TEXPREFIX=$enableval],
    [TEXPREFIX=auto] )
    
AC_ARG_ENABLE(tex-dir,
    [  tex-dir=DIR  set the directory to put LilyPond  TeX files in.],
    [TEXDIR=$enableval],
    [TEXDIR=auto] )

if test $profile_b = yes; then
    EXTRA_LIBES="-pg"
    DEFINES="$DEFINES -pg"
fi
    
if test $printing_b = no; then
    DEFINES="$DEFINES -DNPRINT=1"
fi
    
if test $debug_b = yes; then	
    DEFINES="$DEFINES -g"
fi
if test $checking_b = no; then
    DEFINES="$DEFINES -DNDEBUG=1"
fi

if test $optimise_b = yes; then
    DEFINES="$DEFINES -O2 -DSTRING_UTILS_INLINED"
fi

dnl COMPILEINFO="$HOST $host $TARGET $target"
AUTOHEADER="This file was automatically generated by configure"
CXXFLAGS=${CXXFLAGS:-""}	# we don't want -g -O junk
AC_PROG_CXX
AC_PROG_RANLIB
AC_PROG_INSTALL
AC_CHECK_PROGS(FIND, find, error)

dnl should check out -print
if test FIND = error; then
   AC_MSG_WARN(Couldn't find \`find'.  Please use --enable-tex-dir)
fi
    
AC_SUBST(CXX)
AC_SUBST(DEFINES)
AC_SUBST(COMPILEINFO)
AC_SUBST(AUTOHEADER)
AC_SUBST(BISON)
AC_SUBST(FLEX)
AC_SUBST(TEXPREFIX)
AC_SUBST(TEXDIR)
AC_SUBST(EXTRA_LIBES)

AC_CHECK_PROGS(BISON, bison, error)
AC_CHECK_PROGS(FLEX, flex, error)
AC_CHECK_PROGS(MAKE, make, error)
AC_CHECK_PROGS(PODMAN, pod2man, error)

    
if test "x$TEXPREFIX" = xauto ; then
    AC_TEX_PREFIX(TEXPREFIX)
fi
    
if test "x$TEXDIR" = xauto ; then
    AC_TEX_SUBDIR(TEXDIR)
fi

if test $MAKE = "error" 
then
	AC_MSG_ERROR(Please install GNU make)
else
	$MAKE -v| grep GNU > /dev/null
	if test "$?" = 1
	then
	    AC_MSG_WARN(Please install *GNU* make) 
    fi 
fi 
    
if test $BISON = "error" 
then
	AC_MSG_WARN(can't find bison. Please install Bison (1.24 or better))
fi

if test $PODMAN = "error" 
then
	AC_MSG_WARN(can't find pod. You should install Perl (version 5 or better))
fi

if test $FLEX = "error" 
then
	AC_MSG_WARN(can't find flex. Please install Flex (2.5 or better))
fi

if $CXX --version | grep '2\.7' > /dev/null
then
	true
else
	AC_MSG_WARN(can't find g++ 2.7)
fi

AC_CHECK_HEADER(FlexLexer.h, true,
	AC_MSG_WARN(can't find flex header. Please install Flex headers correctly))
AC_CONFIG_SUBDIRS(flower)
AC_OUTPUT(make/out/Configure_variables.make:make/Configure_variables.make.in
    Makefile:make/Toplevel.make.in
    )



dnl URG!!!!!!
eval "DIR_DATADIR=$datadir"
DIR_DATADIR="$DIR_DATADIR/lilypond"
AC_MSG_CHECKING

cat << EOF > lib/out/config.hh

/* automatically generated by configure */
/* include this file only once! */

#define  DIR_DATADIR "$DIR_DATADIR"

EOF

CXX="$ac_cv_prog_CXX" bin/make_version >> lib/out/config.hh

touch make/out/Site.make

# ugr
(cd mi2mu; CXX="$ac_cv_prog_CXX" ../bin/make_version > out/version.hh
dnl    echo 0 > out/.build
)
# rgu
sed 's/TOPLEVEL_//g' <  .version >  lily/.version
(cd lily; CXX="$ac_cv_prog_CXX" ../bin/make_version > out/version.hh
)

cat << END
Finished configuring. For making everything, do:

	make all

If you only want help on the make targets, do a

	make help


END

    
#if test $shared_b = yes; then
#    echo "NOTE: you are building the *shared* library. You should 
#fi    
