dnl Process this file with autoconf to produce a configure script. -*-shell-script-*-

dnl should cache result.
dnl should  look in $prefix first.

AC_DEFUN(AC_TEX_SUBDIR, [

    # do something sensible if root hasn't specced dir yet attempts install

    AC_MSG_CHECKING(TeX installation directory)

    ac_tmp_prefix=$prefix
    test "x$ac_tmp_prefix" = xNONE && ac_tmp_prefix=$ac_default_prefix

    for texdir in $ac_tmp_prefix $ac_tmp_prefix/lib; do
	if test -d $texdir/texmf; then
	    TEXTOP=$texdir/texmf
	    break
	else	
	if test -d $texdir/tex; then 
	    TEXTOP=$texdir/tex
	    break
	fi
	fi
    done
    $1=$ac_tmp_prefix/lib/texmf/tex
    if test x = "x$TEXTOP"; then
	AC_MSG_WARN(Cannot determine a tex-directory. Please use --enable-texprefix)
    else
	$1=`$FIND $TEXTOP -type d -a -name tex -print |sort|head -1`
    fi
    fi

    AC_MSG_RESULT($$1)
])

AC_INIT(flower/choleski.cc)


AC_LANG_CPLUSPLUS
printing_b=no
checking_b=yes
debug_b=yes
optimise_b=no
profile_b=no
    
AC_ARG_ENABLE(printing,
    [  enable-printing        set debug printing],
    [printing_b=$enableval])

	
AC_ARG_ENABLE(checking,
    [  disable-checking       set runtime checks],
    [checking_b=$enableval] )



AC_ARG_ENABLE(debug,
    [  disable-debug          set debug info],
    [debug_b=$enableval])

AC_ARG_ENABLE(optimise,
    [  enable-optimise       use maximal speed optimisations],
    [optimise_b=$enableval])
    
   
AC_ARG_ENABLE(profiling, 
    [  enable-profiling      compile with gprof support],
    [profile_b=$enableval])
    
AC_ARG_ENABLE(texprefix,
    [  texprefix=DIR  set the tex-directory to put the lilypond subdir in.],
    [TEXPREFIX=$enableval],
    [TEXPREFIX=auto] )
   
if test $profile_b = yes; then
    EXTRA_LIBES="-pg"
    DEFINES="$DEFINES -pg"
fi
    
if test $printing_b = no; then
    DEFINES="$DEFINES -DNPRINT=1"
fi
    
if test $debug_b = yes; then	
    DEFINES="$DEFINES -g"
fi
if test $checking_b = no; then
    DEFINES="$DEFINES -DNDEBUG=1"
fi

if test $optimise_b = yes; then
    DEFINES="$DEFINES -O2 -DSTRING_UTILS_INLINED"
fi
dnl COMPILEINFO="$HOST $host $TARGET $target"
AUTOHEADER="This file was automatically generated by configure"
CXXFLAGS=${CXXFLAGS:-""}	# we don't want -g -O junk
AC_PROG_CXX
AC_PROG_RANLIB
AC_PROG_INSTALL
AC_CHECK_PROGS(FIND, find, error)

dnl should check out -print
if test FIND = error; then
   AC_MSG_WARN(Couldn't find \`find'.  Please use --enable-texprefix)
else 
    
AC_SUBST(DEFINES)
AC_SUBST(COMPILEINFO)
AC_SUBST(AUTOHEADER)
AC_SUBST(BISON)
AC_SUBST(FLEX)
AC_SUBST(TEXPREFIX)
AC_SUBST(EXTRA_LIBES)

AC_CHECK_PROGS(BISON, bison, error)
AC_CHECK_PROGS(FLEX, flex, error)
AC_CHECK_PROGS(MAKE, make, error)
AC_CHECK_PROGS(PODMAN, pod2man, error)

if test $TEXPREFIX = auto ; then
    AC_TEX_SUBDIR(TEXPREFIX)
fi

if test $MAKE = "error" 
then
	AC_MSG_ERROR(Please install GNU make)
else
	$MAKE -v| grep GNU >& /dev/null
	if test "$?" = 1
	then
		AC_MSG_WARN(Please install *GNU* make)
	fi
fi


if test $BISON = "error" 
then
	AC_MSG_WARN(can't find bison. Please install Bison (1.24 or better))
fi

if test $PODMAN = "error" 
then
	AC_MSG_WARN(can't find pod. You should install Perl (version 5 or better))
fi

if test $FLEX = "error" 
then
	AC_MSG_WARN(can't find flex. Please install Flex (2.5 or better))
fi

if $CXX --version | grep '2\.7' >& /dev/null
then
	true
else
	AC_MSG_WARN(can't find g++ 2.7)
fi

AC_CHECK_HEADER(FlexLexer.h, true,
	AC_MSG_WARN(can't find flex header. Please install Flex headers correctly))
AC_CONFIG_SUBDIRS(flower)
AC_OUTPUT(make/out/Configure_variables.make:make/Configure_variables.make.in
    Makefile:make/Toplevel.make.in
    )



dnl URG!!!!!!
eval "DIR_DATADIR=$datadir"
DIR_DATADIR="$DIR_DATADIR/lilypond"
AC_MSG_CHECKING

cat << EOF > lib/out/config.hh

/* automatically generated by configure */
/* include this file only once! */

#define  DIR_DATADIR "$DIR_DATADIR"

EOF

CXX="$ac_cv_prog_CXX" bin/make_version >> lib/out/config.hh

touch make/out/Site.make

# ugr
(cd mi2mu; CXX="$ac_cv_prog_CXX" ../bin/make_version > out/version.hh
dnl    echo 0 > out/.build
)
# rgu
sed 's/TOPLEVEL_//g' <  .version >  lily/.version
(cd lily; CXX="$ac_cv_prog_CXX" ../bin/make_version > out/version.hh
)
 (cd flower;
)

cat << END
Finished configuring. For making everything, do:

	make all

If you only want help on the make targets, do a

	make help

END
