%%
%% include file for LilyPond
%%
%% this file defines various macros to accomodate lilypond output

% TeXbook ex 7.7
\def\ifundefined#1{\expandafter\ifx\csname#1\endcsname\relax}

% skip if included already
\def\SkipLilydefs{\endinput}
\ifundefined{EndLilyPondOutput}
        \def\EndLilyPondOutput{\csname bye\endcsname}
        \def\SkipLilydefs{}
\fi
\SkipLilydefs

\ifundefined{mudelacopyright}
        \def\mudelacopyright{\copyright\ \number\year}
\fi
\ifundefined{LilyIdString}
        \def\LilyIdString{Lily was here}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% macros to shorten other definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\musicdef#1#2{\def#1{\musicchar{#2}}}
\def\musicchar#1{\musicfnt\char#1}
\def\rationalmultiply#1*#2/#3{\multiply #1 by #2 \divide #1 by #3}


\def\maccentraise#1#2{\dimen0=\noteheight
        \rationalmultiply\dimen0*#2%
        \raise\dimen0\hbox{#1}}
\def\maccentdef#1#2#3{\def#1{\maccentraise{\musicchar{#2}}{#3}}}
\def\vertcenter#1{\vbox to 0pt{\vss #1\vss}}

\def\musicmathdef#1#2{\def#1{\musicmathchar{#2}}}
\def\musicmathchar#1{\musicmathfont\char#1}

\def\topalign#1{\vbox to 0pt{#1\vss}}
\def\botalign#1{\vbox to 0pt{\vss #1}}

\def\centeralign#1{\hbox to 0pt{\hss#1\hss}}
\def\leftalign#1{\hbox to 0pt{#1\hss}}
\def\rightalign#1{\hbox to 0pt{\hss#1}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% set up dimensions
\parindent=0pt
\newdimen\smallspace
\newdimen\interlinedist
\newcount\n
\newdimen\balkheight
\newdimen\notewidth
\newdimen\noteheight
\newdimen\staffrulethickness
\newdimen\interstaffrule
\newdimen\dist

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% set fonts and primary dimensions
% ugh
\def\musixtwentydefs{
        \balkheight=20pt
        \notewidth=7.15pt
        \noteheight=5pt
        \musixtwentyfonts
        \font\textmusic=cmmi12
        \musixcalc
}

\def\musixsixteendefs{
        \balkheight=16pt
        \notewidth=5.93pt
        \noteheight=4pt
        \musixsixteenfonts
        \font\textmusic=cmmi10
        \musixcalc
}

\def\textsharp{\raise.4ex\hbox{\textmusic\char"5D}}
\def\textnatural{\raise.4ex\hbox{\textmusic\char"5C}}
\def\textflat{\raise.2ex\hbox{\mus\char"5B}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% do derivative calcs

\def\musixcalc{
        \interlinedist=\fontdimen5\musicfnt
        \smallspace=.3\interlinedist
        \interstaffrule=\balkheight
        \divide\interstaffrule by 4

        %  [D.K.Roush & J.S.Gourlay] say this should be 0.072
        % We know better
        \staffrulethickness=0.1\interlinedist
}


\input dyndefs

\input taupindefs
%\input eglerdefs

\musicmathdef\cup{91} % \cup
\musicmathdef\wedge{94} % \wedge
\musicmathdef\striepke{0} % heu?

%% custom characters --- this should go: add to (meta!) font
% \def\myheel{\kern-.5ex\vbox{\cup}\kern-.5ex}
% \def\mytoe{\kern-.5ex\vbox{\wedge}\kern-.5ex}
\def\myheel{\vbox{\cup}}
\def\mytoe{\vbox{\wedge}}
% \def\mystriepke{\kern-1.1ex\vbox{\hbox{\kern-.05em\striepke}}\kern-1.1ex}
\def\mystriepke{\kern-1.8ex\vbox{\hbox{\kern-.05em\striepke}}\kern-1.8ex}

\def\heel{\vbox{\myheel}}
\def\toe{\vbox{\mytoe}}
\def\backorfront{\mystriepke}

\def\bheel{\vbox{\myheel\mystriepke}}
\def\btoe{\vbox{\mytoe\mystriepke}}
\def\fheel{\vbox{\mystriepke\myheel}}
\def\ftoe{\vbox{\mystriepke\mytoe}}
\def\heeltoe{\vbox{\myheel\mytoe}}
\def\toeheel{\vbox{\mytoe\myheel}}
%%

\def\emptybar{}

\def\defaultthinbar{\thinbar{\balkheight}}
\def\defaultthickbar{\thickbar{\balkheight}}
%? what-s wrong with rightalign?
\def\repeatstopbar{\hss\rightalign{\repeatcolon\hskip2\smallspace\defaultthinbar\hskip\smallspace\defaultthickbar}}
\def\repeatstartbar{\hbox{\defaultthickbar\kern\smallspace\defaultthinbar\kern2\smallspace\repeatcolon}}
\def\repeatstopstart{\hbox{\repeatcolon\kern2\smallspace\defaultthinbar\kern\smallspace\defaultthickbar\kern\smallspace\defaultthickbar\kern\smallspace\defaultthinbar\kern2\smallspace\repeatcolon}}

%compatibility
\def\repeatbar{\repeatstopbar}
\def\startrepeat{\repeatstartbar}
\def\repeatbarstartrepeat{\repeatstopstart}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% parametric symbols
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\doublebar#1{\hbox{\thinbar{#1}\hskip\smallspace\thinbar{#1}}}
\def\thinbar#1{\vrule height #1 width 1.6\staffrulethickness} % TODO parametric.
\def\thickbar#1{\vrule height #1 width 2\smallspace}
\def\maatstreep#1{\thinbar{#1}}
\def\startbar#1{\leftalign{\thickbar{#1}\kern\smallspace\thinbar{#1}}}
\def\finishbar#1{\rightalign{\thinbar{#1}\kern\smallspace\thickbar{#1}}}

\def\pianobrace#1{{\musicdraw\char#1}}
\def\slurcharh#1{{\slurhfont\char#1}}
\def\slurcharu#1{{\slurufont\char#1}}
\def\slurchard#1{{\slurdfont\char#1}}
\def\hslurcharh#1{{\hslurhfont\char#1}}
\def\hslurcharu#1{{\hslurufont\char#1}}
\def\hslurchard#1{{\hslurdfont\char#1}}
% stacked numbers
\def\generalmeter#1#2{\botalign{\vbox to0.5\balkheight{\vss \meterfont#1}%
        \nointerlineskip
        \vbox to 0.5\balkheight{\vss\meterfont #2}}}

% stacked horizontal lines 
\def\lines#1#2#3{%
 \vbox{\kern-\interstaffrule
        \n=0\nointerlineskip%
        \loop\ifnum\n<#1\advance\n by1%
                \kern\interstaffrule
                \nointerlineskip
                \vbox to 0pt{\hrule height #3 width#2%
                        \vss}\nointerlineskip
                \repeat
        }}

%%
% Ugh. Need to redo this. Wish we had PS.
%
\def\toplines#1#2{\dist#1
        \topalign{\hbox{\kern-.25\dist\lines{#2}{1.5\dist}{2\staffrulethickness}}}}

\def\botlines#1#2{\dist#1
        \botalign{\hbox{\kern-.25\dist\lines{#2}{1.5\dist}{2\staffrulethickness}}}}

%
% a staffsymbol with #1 lines, width #2
% bottom at baseline
\def\linestafsym#1#2{\leftalign{\botalign{\lines{#1}{#2}{\staffrulethickness}}}}

\def\stem#1#2{\vrule height#2 depth-#1}

\def\placebox#1#2#3{%
        \botalign{\hbox{\raise #1\leftalign{\kern #2{}#3}}}%
}


\def\brace#1{\count0=148\advance\count0 by #1\musicdraw\char\count0}
\def\crescendosym#1{\count0=84\advance\count0 by #1\musicdraw\char\count0}
\def\decrescendosym#1{\count0=116\advance\count0 by #1\musicdraw\char\count0}
\def\rulesym#1#2{\vrule height #1 width #2}
\def\settext#1{\normaltextfont #1}
\def\setitalic#1{\italicfont #1}
\def\setdynamic#1{\dynfont #1}

% the interline symbol. Redefine to remove it.
\def\defaultlineseparator{\vbox{\mussepline\vskip -5pt\mussepline}}
\def\lineseparator{\defaultlineseparator}
\def\beauty{%
        \par\vskip 10pt plus 30pt minus 10pt\par
        \hskip -5pt\lineseparator
        \par\vskip 10pt plus 30pt minus 10pt\par
}


\def\interscoreline{\vskip 16pt}
        
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% big fat marks, if errors are detected.
\def\columnerrormark{\placebox{-5pt}{0pt}{\bf C!}}
\def\scorelineerrormark{\placebox{0pt}{-10pt}{\bf L!}}
\def\errormark{{\bf E!}}
\def\unknown{{\bf u}}

\def\postheader{}
\ifundefined{documentclass}
        \footline={\ifnum\pageno=1
        {\smalltextfont\mudelacopyright\hfil \LilyIdString
        }\else{\hfil\the\pageno\hfil}\fi
}\else
        %% FIXME
        \def\ps@plain{
                \renewcommand{\@oddhead}{}%
                \renewcommand{\@evenfoot}{}%
                \renewcommand{\@evenhead}{}%
                \renewcommand{\@oddfoot}{\ifnum\thepage=1
        {\hfil \LilyIdString
        }\else{foo\hfil\the\pageno\hfil}\fi}}
        \def\ps@empty{
                \renewcommand{\@oddhead}{}%
                \renewcommand{\@evenfoot}{}%
                \renewcommand{\@evenhead}{}%
                \renewcommand{\@oddfoot}{\ifnum\thepage=1
        {\hfil \LilyIdString
        }\else{foo\hfil\the\pageno\hfil}\fi}}
\fi

 
