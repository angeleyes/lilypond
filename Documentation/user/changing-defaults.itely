@c -*- coding: utf-8; mode: texinfo; -*-
@node Changing defaults
@chapter Changing defaults


The purpose of LilyPond's design is to provide the finest output
quality as a default.  Nevertheless, it may happen that you need to
change this default layout.  The layout is controlled through a large
number of proverbial ``knobs and switches.''  This chapter does not
list each and every knob.  Rather, it outlines what groups of controls
are available and explains how to lookup which knob to use for a
particular effect.


@cindex Program reference

The controls available for tuning are described in a separate
document, the
@iftex
Program reference
@end iftex
@ifnottex
@ref{lilypond-internals,Program reference,,lilypond-internals}.
@end ifnottex
manual.  That manual
lists all different variables, functions and options available in
LilyPond.  It is written as a HTML document, which is available
@uref{http://@/lilypond@/.org/@/doc@/v2.5/@/Documentation/@/user/@/out@/-www/@/lilypond@/-internals/,on@/-line},
but is also included with the LilyPond documentation package.

There are three areas where the default settings may be changed:

@itemize @bullet
@item
Output: changing the appearance of individual
objects.  For example, changing stem directions or the location of
subscripts.
  
@item
Context: changing aspects of the translation from music events to
notation.  For example, giving each staff a separate time signature. 
  
@item
Global layout: changing the appearance of the spacing, line
breaks, and page dimensions.
@end itemize

Then there are separate systems for typesetting text (like
@emph{ritardando}) and selecting different fonts.  This chapter also
discusses these.

Internally, LilyPond uses Scheme (a LISP dialect) to provide
infrastructure.  Overriding layout decisions in effect accesses the
program internals, which requires Scheme input.  Scheme elements are
introduced in a @code{.ly} file with the hash mark
@code{#}.@footnote{@ref{Scheme tutorial} contains a short tutorial
on entering numbers, lists, strings, and symbols in Scheme.}


@menu
* Interpretation contexts::     
* The \override command::       
* Fonts::                       
* Text markup::                 
@end menu

 
@node Interpretation contexts
@section Interpretation contexts

When music is printed, a lot of notational elements must be added to the
input, which is often bare bones.  For example, compare the input and
output of the following example:

@lilypond[quote,verbatim,relative=2,fragment]
cis4 cis2. g4
@end lilypond

The input is rather sparse, but in the output, bar lines, accidentals,
clef, and time signature are added.  LilyPond @emph{interprets} the
input.  During this step, the musical information is inspected in time
order, similar to reading a score from left to right.  While reading,
the input, the program remembers where measure boundaries are, and what
pitches need explicit accidentals.  This information can be presented on
several levels.  For example, the effect of an accidental is limited
to a single staff, while a bar line must be synchronized across the
entire score.

Within LilyPond, these rules and bits of information are grouped in
so-called Contexts.  Examples of context are @context{Voice},
@context{Staff}, and @context{Score}.  They are hierarchical, for
example, a @context{Staff} can contain many @context{Voice}s, and a
@context{Score} can contain many @context{Staff} contexts.

Each context has the responsibility for enforcing some notation rules,
creating some notation objects and maintaining the associated
properties.  So, the synchronization of bar lines is handled at
@context{Score} context.  The @context{Voice} may introduce an
accidental and then the @context{Staff} context maintains the rule to
show or suppress the accidental for the remainder of the measure.

For simple scores, contexts are created implicitly, and you need not
be aware of them.  For larger pieces, such as piano music, they must be
created explicitly to make sure that you get as many staves as you
need, and that they are in the correct order.  For typesetting pieces
with specialized notation, it can be useful to modify existing or
to define new contexts.


A complete description of all available contexts is in the program
reference, see
@ifhtml
@internalsref{Contexts}.
@end ifhtml
@ifnothtml 
Translation @arrow{} Context.
@end ifnothtml

@c [TODO: describe propagation]


@menu
* Creating contexts::           
* Changing context properties on the fly::  
* Modifying context plug-ins::  
* Layout tunings within contexts::  
* Changing context default settings::  
* Defining new contexts::       
@end menu

@node Creating contexts
@subsection Creating contexts

For scores with only one voice and one staff, correct contexts are
created automatically.  For more complex scores, it is necessary to
create them by hand.  There are three commands that do this.

The easiest command is @code{\new}, and it also the quickest to type.
It is prepended to a music expression, for example

@cindex @code{\new}
@cindex new contexts
@cindex Context, creating

@example
\new @var{type} @var{music expression}
@end example

@noindent
where @var{type} is a context name (like @code{Staff} or
@code{Voice}).  This command creates a new context, and starts
interpreting the @var{music expression} with that.

A practical application of @code{\new} is a score with many
staves.  Each part that should be on its own staff, is preceded with 
@code{\new Staff}.

@lilypond[quote,verbatim,relative=2,raggedright,fragment]
<< \new Staff { c4 c }
   \new Staff { d4 d }
>>
@end lilypond

@cindex @code{\context}

Like @code{\new}, the @code{\context} command also directs a music
expression to a context object, but gives the context an extra name.  The
syntax is

@example
\context @var{type} = @var{id} @var{music}
@end example

This form will search for an existing context of type @var{type}
called @var{id}.  If that context does not exist yet, it is created.
This is useful if the context is referred to later on.  For example, when
setting lyrics the melody is in a named context

@example
\CONtext Voice = "@b{tenor}" @var{music}
@end example

@noindent
so the texts can be properly aligned to its notes,

@example
\new Lyrics \lyricsto "@b{tenor}" @var{lyrics} 
@end example

@noindent

Another possibility is funneling two different music expressions into
one context.  In the following example, articulations and notes are
entered separately,

@example
music = @{ c4 c4 @}
arts = @{ s4-. s4-> @}
@end example

They are combined by sending both to the same @context{Voice} context,

@example
<< \new Staff \context Voice = "A" \music
   \context Voice = "A" \arts
>>
@end example
@lilypond[quote,raggedright]
music = { c4 c4 }
arts = { s4-. s4-> }
\relative c'' <<
  \new Staff \context Voice = "A" \music
  \context Voice = "A" \arts
>>
@end lilypond

With this mechanism, it is possible to define an Urtext (original
edition), with the option to put several distinct articulations on the
same notes.

@cindex @code{\context}
@cindex creating contexts

The third command for creating contexts is
@example
\context @var{type} @var{music}
@end example


@noindent
This is similar to @code{\context} with @code{= @var{id}}, but matches
any context of type @var{type}, regardless of its given name.

This variant is used with music expressions that can be interpreted at
several levels.  For example, the @code{\applyoutput} command (see
@ref{Running a function on all layout objects}).  Without an explicit
@code{\context}, it is usually applied to @context{Voice}

@example
\applyoutput #@var{function}   % apply to Voice
@end example

To have it interpreted at the @context{Score} or @context{Staff} level use
these forms

@example
\context Score \applyoutput #@var{function}
\context Staff \applyoutput #@var{function}
@end example


@node Changing context properties on the fly
@subsection Changing context properties on the fly

@cindex properties
@cindex @code{\set}
@cindex changing properties

Each context can have different @emph{properties}, variables contained
in that context.  They can be changed during the interpretation step.
This is achieved by inserting the @code{\set} command in the music,

@example
\set @var{context}.@var{prop} = #@var{value}
@end example

For example,
@lilypond[quote,verbatim,relative=2,fragment]
R1*2 
\set Score.skipBars = ##t
R1*2
@end lilypond

This command skips measures that have no notes.  The result is that
multi-rests are condensed.  The value assigned is a Scheme object.  In
this case, it is @code{#t}, the boolean True value.

If the @var{context} argument is left out, then the current bottom-most
context (typically @context{ChordNames}, @context{Voice}, or
@context{Lyrics}) is used.  In this example,

@lilypond[quote,verbatim,relative=2,fragment]
c8 c c c
\set autoBeaming = ##f
c8 c c c
@end lilypond

@noindent
the @var{context} argument to @code{\set} is left out, so automatic
beaming is switched off in the current @internalsref{Voice}.  Note that
the bottom-most context does not always contain the property that you
wish to change -- for example, attempting to set the @code{skipBars}
property (of the bottom-most context, in this case @code{Voice}) will
have no effect.

@lilypond[quote,verbatim,relative=2,fragment]
R1*2 
\set skipBars = ##t
R1*2
@end lilypond

Contexts are hierarchical, so if a bigger context was specified, for
example @context{Staff}, then the change would also apply to all
@context{Voice}s in the current stave.  The change is applied
`on-the-fly', during the music, so that the setting only affects the
second group of eighth notes.

@cindex @code{\unset} 

There is also an @code{\unset} command,
@example
\unset @var{context}.@var{prop}
@end example

@noindent
which removes the definition of @var{prop}.  This command removes
the definition only if it is set in @var{context}, so

@example
\set Staff.autoBeaming = ##f
@end example

@noindent
introduces a property setting at @code{Staff} level.  The setting also
applies to the current @code{Voice}.  However,

@example
\unset Voice.autoBeaming
@end example

@noindent
does not have any effect.  To cancel this setting, the @code{\unset}
must be specified on the same level as the original @code{\set}.  In
other words, undoing the effect of @code{Staff.autoBeaming = ##f}
requires
@example
\unset Staff.autoBeaming
@end example

Like @code{\set}, the @var{context} argument does not have to be
specified for a bottom context, so the two statements

@example
\set Voice.autoBeaming = ##t 
\set autoBeaming = ##t 
@end example 

@noindent
are equivalent.


@cindex \once
Settings that should only apply to a single time-step can be entered
with @code{\once}, for example in

@lilypond[quote,verbatim,relative=2,fragment]
c4
\once \set fontSize = #4.7
c4
c4
@end lilypond

the property @code{fontSize} is unset automatically after the second
note.

A full description of all available context properties is in the
program reference, see
@ifhtml
@internalsref{Tunable context properties}.
@end ifhtml
@ifnothtml
Translation @arrow{} Tunable context properties.
@end ifnothtml


@node Modifying context plug-ins
@subsection Modifying context plug-ins

Notation contexts (like Score and Staff) not only store properties,
they also contain plug-ins, called ``engravers'' that create notation
elements.  For example, the Voice context contains a
@code{Note_head_engraver} and the Staff context contains a
@code{Key_signature_engraver}.

For a full a description of each plug-in, see 
@ifhtml
@internalsref{Engravers}.
@end ifhtml
@ifnothtml
Program reference @arrow Translation @arrow{} Engravers.
@end ifnothtml
Every context described in
@ifhtml
@internalsref{Contexts}
@end ifhtml
@ifnothtml 
Program reference @arrow Translation @arrow{} Context.
@end ifnothtml
lists the engravers used for that context.


It can be useful to shuffle around these plug-ins.  This is done by
starting a new context, with @code{\new} or @code{\context}, and
modifying it like this, 

@example
\new @var{context} \with @{
  \consists @dots{}
  \consists @dots{}
  \remove @dots{}
  \remove @dots{}
  @emph{etc.}
@}
@emph{..music..}
@end example

@noindent
where the @dots{} should be the name of an engraver.  Here is a simple
example which removes @code{Time_signature_engraver} and
@code{Clef_engraver} from a @code{Staff} context,

@lilypond[quote,relative=1,verbatim,fragment]
<< \new Staff {
    f2 g
  }
  \new Staff \with {
     \remove "Time_signature_engraver"
     \remove "Clef_engraver"
  } {
    f2 g2
  }
>>
@end lilypond

In the second staff there are no time signature or clef symbols.  This
is a rather crude method of making objects disappear since it will affect
the entire staff.  The spacing is adversely influenced too.  A more
sophisticated method of blanking objects is shown in @ref{Common tweaks}.

The next example shows a practical application.  Bar lines and time
signatures are normally synchronized across the score.  This is done
by the @code{Timing_engraver}.  This plug-in keeps an administration of
time signature, location within the measure, etc.  By moving the
@code{Timing_engraver} engraver from @code{Score} to @code{Staff}
context, we can have a score where each staff has its own time
signature.

@cindex polymetric scores
@cindex Time signatures, multiple

@lilypond[quote,relative=1,raggedright,verbatim,fragment]
\new Score \with {
  \remove "Timing_engraver"
} <<
  \new Staff \with {
    \consists "Timing_engraver"
  } {
      \time 3/4
      c4 c c c c c
  }
  \new Staff \with {
    \consists "Timing_engraver"
  } {
       \time 2/4
       c4 c c c c c
  }
>>
@end lilypond


@node Layout tunings within contexts
@subsection Layout tunings within contexts

Each context is responsible for creating certain types of graphical
objects.  The settings used for printing these objects are also stored by
context.  By changing these settings, the appearance of objects can be
altered.
 
The syntax for this is

@example
\override @var{context}.@var{name} #'@var{property} = #@var{value}
@end example

Here @var{name} is the name of a graphical object, like @code{Stem} or
@code{NoteHead}, and @var{property} is an internal variable of the
formatting system (`grob property' or `layout property').  The latter is a
symbol, so it must be quoted.  The subsection @ref{Constructing a
tweak} explains what to fill in for @var{name}, @var{property}, and
@var{value}.  Here we only discuss the functionality of this command.

The command

@verbatim
\override Staff.Stem #'thickness = #4.0 
@end verbatim

@noindent
makes stems thicker (the default is 1.3, with staff line thickness as a
unit).  Since the command specifies @context{Staff} as context, it only
applies to the current staff.  Other staves will keep their normal
appearance.  Here we see the command in action:

@lilypond[quote,verbatim,relative=2,fragment]
c4
\override Staff.Stem #'thickness = #4.0 
c4
c4
c4
@end lilypond

The @code{\override} command changes the definition of the @code{Stem}
within the current @context{Staff}.  After the command is interpreted
all stems are thickened.

Analogous to @code{\set}, the @var{context} argument may be left out,
causing it to default to @context{Voice}, and adding @code{\once} applies
the change during one timestep only 

@lilypond[quote,fragment,verbatim,relative=2]
c4
\once \override Stem #'thickness = #4.0 
c4
c4 
@end lilypond

The @code{\override} must be done before the object is
started.  Therefore, when altering @emph{Spanner} objects, like slurs or
beams, the @code{\override} command must be executed at the moment when
the object is created.  In this example,


@lilypond[quote,fragment,verbatim,relative=2]
\override Slur #'thickness = #3.0
c8[( c
\override Beam #'thickness = #0.6
c8 c]) 
@end lilypond

@noindent
the slur is fatter but the beam is not.  This is because the command for
@code{Beam} comes after the Beam is started.  Therefore it has no effect.

Analogous to @code{\unset}, the @code{\revert} command for a context
undoes an @code{\override} command; like with @code{\unset}, it only
affects settings that were made in the same context.  In other words, the
@code{\revert} in the next example does not do anything.

@example
\override Voice.Stem #'thickness = #4.0
\revert Staff.Stem #'thickness
@end example




@seealso

Internals: @internalsref{OverrideProperty}, @internalsref{RevertProperty},
@internalsref{PropertySet}, @internalsref{All-backend-properties}, and
@internalsref{All layout objects}.


@refbugs

The back-end is not very strict in type-checking object properties.
Cyclic references in Scheme values for properties can cause hangs
or crashes, or both.


@node Changing context default settings
@subsection Changing context default settings

The adjustments of the previous subsections (@ref{Changing context
properties on the fly}, @ref{Modifying context plug-ins}, and
@ref{Layout tunings within contexts}) can also be entered separately
from the music, in the @code{\layout} block,

@example
\layout @{
  @dots{}
  \context @{
    \Staff

    \set fontSize = #-2
    \override Stem #'thickness = #4.0
    \remove "Time_signature_engraver"
  @}
@}
@end example

Here
@example
\Staff
@end example

@noindent
takes the existing definition for context @context{Staff} from the
identifier @code{\Staff}. 

The statements
@example
\set fontSize = #-2
\override Stem #'thickness = #4.0
\remove "Time_signature_engraver"
@end example

@noindent
affect all staves in the score.

Other contexts can be modified analogously.

The @code{\set} keyword is optional within the @code{\layout} block, so

@example
\context @{
  @dots{}
  fontSize = #-2
@}
@end example

@noindent
will also work.



@refbugs

It is not possible to collect context changes in a variable, and apply
them to one @code{\context} definition by referring to that variable.

The @code{\RemoveEmptyStaffContext} will override your current
@code{\Staff} variable.  If you wish to change the defaults for a
staff that uses @code{\RemoveEmptyStaffContext}, you must do so
after calling @code{\RemoveemptyStaffContext}, ie

@example
\layout @{
  \context @{
    \RemoveEmptyStaffContext

    \override Stem #'thickness = #4.0
  @}
@}
@end example


@node Defining new contexts
@subsection Defining new contexts

Specific contexts, like @context{Staff} and @code{Voice}, are made of
simple building blocks, and it is possible to compose engraver
plug-ins in different combinations, thereby creating new types of
contexts.

The next example shows how to build a different type of
@context{Voice} context from scratch.  It will be similar to
@code{Voice}, but prints centered slash noteheads only.  It can be used
to indicate improvisation in Jazz pieces,

@lilypond[quote,raggedright]
\layout { \context {
  \name ImproVoice
  \type "Engraver_group_engraver"
  \consists "Note_heads_engraver"
  \consists "Text_engraver"
  \consists Pitch_squash_engraver
  squashedPosition = #0
  \override NoteHead #'style = #'slash
  \override Stem #'transparent = ##t
  \alias Voice
}
\context { \Staff
  \accepts "ImproVoice"
}}

\relative c'' {
  a4 d8 bes8 \new ImproVoice { c4^"ad lib" c 
   c4 c^"undress" c_"while playing :)" c } 
  a1 
}
@end lilypond


These settings are again done within a @code{\context} block inside a
@code{\layout} block,

@example
\layout @{
  \context @{
    @dots{}
  @}
@}
@end example

In the following discussion, the example input shown should go on the
@dots{} in the previous fragment.

First, the context gets a name.  Instead of @context{Voice} it
will be called @context{ImproVoice},

@example
\name ImproVoice
@end example

Since it is similar to the @context{Voice}, we want commands that work
on (existing) @context{Voice}s to remain working.  This is achieved by
giving the new context an alias @context{Voice},

@example
\alias Voice
@end example

The context will print notes, and instructive texts

@example
\consists Note_heads_engraver
\consists Text_engraver
@end example

but only on the center line,

@example
\consists Pitch_squash_engraver
squashedPosition = #0
@end example

The @internalsref{Pitch_squash_engraver} modifies note heads (created
by @internalsref{Note_heads_engraver}) and sets their vertical
position to the value of @code{squashedPosition}, in this case@tie{}@code{0},
the center line.

The notes look like a slash, without a stem,

@example
\override NoteHead #'style = #'slash
\override Stem #'transparent = ##t
@end example


All these plug-ins have to cooperate, and this is achieved with a
special plug-in, which must be marked with the keyword @code{\type}.
This should always be @internalsref{Engraver_group_engraver},

@example
\type "Engraver_group_engraver"
@end example

Put together, we get

@example
\context @{
  \name ImproVoice
  \type "Engraver_group_engraver"
  \consists "Note_heads_engraver"
  \consists "Text_engraver"
  \consists Pitch_squash_engraver
  squashedPosition = #0
  \override NoteHead #'style = #'slash
  \override Stem #'transparent = ##t
  \alias Voice
@}
@end example

Contexts form hierarchies.  We want to hang the @context{ImproVoice}
under @context{Staff}, just like normal @code{Voice}s.  Therefore, we
modify the @code{Staff} definition with the @code{\accepts}
command,@footnote{The opposite of @code{\accepts} is @code{\denies},
which is sometimes needed when reusing existing context definitions.}



@example
\context @{
  \Staff
  \accepts ImproVoice    
@}
@end example

Putting both into a @code{\layout} block, like

@example
\layout @{
  \context @{
    \name ImproVoice
    @dots{}
  @}
  \context @{
    \Staff
    \accepts "ImproVoice"
  @}
@}
@end example

Then the output at the start of this subsection can be entered as

@example
\relative c'' @{
  a4 d8 bes8
  \new ImproVoice @{
    c4^"ad lib" c 
    c4 c^"undress"
    c c_"while playing :)"
  @}
  a1
@}
@end example
  

    

@node The \override command
@section The \override command

In the previous section, we have already touched on a command that
changes layout details: the @code{\override} command.  In this section,
we will look in more detail at how to use the command in practice.
First, we will give a few versatile commands that are sufficient
for many situations.  The next section will discuss the general use of
@code{\override}.


@menu
* Common tweaks::               
* Constructing a tweak::        
* Navigating the program reference::  
* Layout interfaces::           
* Determining the grob property::  
* Difficult tweaks::            
@end menu



@node Common tweaks
@subsection Common tweaks

@c  Should we point at ly/property-init.ly ?  -gp
Some overrides are so common that predefined commands are provided as
short-cuts, for example, @code{\slurUp} and @code{\stemDown}.  These
commands are described in
@ifhtml
the
@end ifhtml
@c @ref{Notation manual},
Notation manual
@c FIXME 
under the sections for slurs and stems
respectively.

The exact tuning possibilities for each type of layout object are
documented in the program reference of the respective
object.  However, many layout objects share properties, which can be
used to apply generic tweaks.  We mention a few of these:

@itemize @bullet
@item The @code{extra-offset} property, which
@cindex @code{extra-offset}
has a pair of numbers as value, moves objects around in the printout.
The first number controls left-right movement; a positive number will
move the object to the right.  The second number controls up-down
movement; a positive number will move it higher.  The units of these
offsets are staff-spaces.  The @code{extra-offset} property is a
low-level feature: the formatting engine is completely oblivious to
these offsets.

In the following example, the second fingering is moved a little to
the left, and 1.8 staff space downwards:

@cindex setting object properties

@lilypond[quote,fragment,relative=1,verbatim]
\stemUp
f-5
\once \override Fingering
    #'extra-offset = #'(-0.3 . -1.8) 
f-5
@end lilypond

@item
Setting the @code{transparent} property will cause an object to be printed
in `invisible ink': the object is not printed, but all its other
behavior is retained.  The object still takes up space, it takes part in
collisions, and slurs, ties, and beams can be attached to it.

@cindex transparent objects
@cindex removing objects
@cindex hiding objects
@cindex invisible objects
The following example demonstrates how to connect different voices
using ties.  Normally, ties only connect two notes in the same
voice.  By introducing a tie in a different voice,

@lilypond[quote,fragment,relative=2]
<< {
  b8~ b8\noBeam
} \\ {
  b[ g8]
} >>
@end lilypond

@noindent
and blanking the first up-stem in that voice, the tie appears to cross
voices:

@lilypond[quote,fragment,relative=2,verbatim]
<< {
  \once \override Stem #'transparent = ##t
  b8~ b8\noBeam
} \\ {
  b[ g8]
} >>
@end lilypond

@item
The @code{padding} property for objects with
@cindex @code{padding}
@code{side-position-interface} can be set to increase the distance between
symbols that are printed above or below notes.  We only give an
example; a more elaborate explanation is in @ref{Constructing a
tweak}:

@lilypond[quote,fragment,relative=1,verbatim]
c2\fermata
\override Script #'padding = #3
b2\fermata
@end lilypond

@end itemize

More specific overrides are also possible.  The next section
discusses in depth how to figure out these statements for yourself.


@node Constructing a tweak
@subsection Constructing a tweak

The general procedure of changing output, that is, entering
a command like

@example
\override Voice.Stem #'thickness = #3.0
@end example

@noindent
means that we have to determine these bits of information:

@itemize
@item the context: here @context{Voice}.
@item the layout object: here @code{Stem}.
@item the layout property: here @code{thickness}
@item a sensible value: here @code{3.0}
@end itemize  


@cindex internal documentation
@cindex finding graphical objects
@cindex graphical object descriptions 
@cindex tweaking
@cindex @code{\override}
@cindex internal documentation

We demonstrate how to glean this information from the notation manual
and the program reference.

@node Navigating the program reference
@subsection Navigating the program reference

Suppose we want to move the fingering indication in the fragment
below:

@lilypond[quote,fragment,relative=2,verbatim]
c-2
\stemUp
f
@end lilypond

If you visit the documentation on fingering instructions (in
@ref{Fingering instructions}), you will notice that there is written:

@quotation
@seealso

Program reference: @internalsref{FingerEvent} and @internalsref{Fingering}.

@end quotation



This fragment points to two parts of the program reference: a page
on @code{FingerEvent} and one on @code{Fingering}.

The page on @code{FingerEvent} describes the properties of the music
expression for the input @code{-2}.  The page contains many links
forward.  For example, it says

@quotation
Accepted by: @internalsref{Fingering_engraver},
@end quotation 

@noindent
That link brings us to the documentation for the Engraver, the
plug-in, which says

@quotation
This engraver creates the following layout objects: @internalsref{Fingering}.
@end quotation

In other words, once the @code{FingerEvent}s are interpreted, the
@code{Fingering_engraver} plug-in will process them.
The @code{Fingering_engraver} is also listed to create
@internalsref{Fingering} objects,


Lo and behold, that is also the
second bit of information listed under @b{See also} in the Notation
manual.  By clicking around in the program reference, we can follow the
flow of information within the program, either forward (like we did
here), or backwards, following links like this:

@itemize @bullet

@item @internalsref{Fingering}:
@internalsref{Fingering} objects are created by:
@b{@internalsref{Fingering_engraver}}

@item @internalsref{Fingering_engraver}:
Music types accepted: @b{@internalsref{fingering-event}}

@item @internalsref{fingering-event}:
Music event type @code{fingering-event} is in Music expressions named
@b{@internalsref{FingerEvent}}
@end itemize

This path goes against the flow of information in the program: it
starts from the output, and ends at the input event.

The program reference can also be browsed like a normal document.  It
contains a chapter on
@ifhtml
@internalsref{Music definitions},
@end ifhtml
@ifnothtml
@code{Music definitions}
@end ifnothtml
on @internalsref{Translation}, and the @internalsref{Backend}.  Every
chapter lists all the definitions used, and all properties that may be
tuned.

 
@node Layout interfaces
@subsection Layout interfaces

@cindex interface, layout
@cindex layout interface

The HTML page that we found in the previous section, describes the
layout object called @internalsref{Fingering}.  Such an object is a
symbol within the score.  It has properties that store numbers (like
thicknesses and directions), but also pointers to related objects.  A
layout object is also called @emph{grob},
@cindex grob
which is short for Graphical Object.


The page for @code{Fingering} lists the definitions for the
@code{Fingering} object.  For example, the page says

@quotation
@code{padding} (dimension, in staff space):
  
@code{0.6}
@end quotation

@noindent
which means that the number will be kept at a distance of at least 0.6
of the note head.


Each layout object may have several functions as a notational or
typographical element.  For example, the Fingering object
has the following aspects

@itemize @bullet
@item
Its size is independent of the horizontal spacing, unlike slurs or beams.

@item
It is a piece of text.  Granted, it is usually a very short text.

@item
That piece of text is typeset with a font, unlike slurs or beams.

@item
Horizontally, the center of the symbol should be aligned to the
center of the notehead.

@item
Vertically, the symbol is placed next to the note and the staff.

@item
The vertical position is also coordinated with other super- and subscript
symbols.
@end itemize

Each of these aspects is captured in so-called @emph{interface}s,
which are listed on the @internalsref{Fingering} page at the bottom

@quotation
This object supports the following interfaces:
@internalsref{item-interface},
@internalsref{self-alignment-interface},
@internalsref{side-position-interface}, @internalsref{text-interface},
@internalsref{text-script-interface}, @internalsref{font-interface},
@internalsref{finger-interface}, and @internalsref{grob-interface}.
@end quotation

Clicking any of the links will take you to the page of the respective
object interface.  Each interface has a number of properties.  Some of
them are not user-serviceable (``Internal properties''), but others
are.

We have been talking of @emph{the} @code{Fingering} object, but actually it
does not amount to much.  The initialization file
@file{scm/@/define@/-grobs@/.scm} shows the soul of the `object',

@example
(Fingering
  . ((print-function . ,Text_interface::print)
     (padding . 0.6)
     (staff-padding . 0.6)
     (self-alignment-X . 0)
     (self-alignment-Y . 0)
     (script-priority . 100)
     (font-size . -5)
     (meta . ((interfaces . (finger-interface font-interface
                             text-script-interface text-interface
                             side-position-interface
                             self-alignment-interface
                             item-interface))))))
@end example

@noindent
As you can see, the @code{Fingering} object is nothing more than a
bunch of variable settings, and the webpage in the Program Reference
is directly generated from this definition.

@node Determining the grob property
@subsection Determining the grob property


Recall that we wanted to change the position of the @b{2} in 

@lilypond[quote,fragment,relative=2,verbatim]
c-2
\stemUp
f
@end lilypond

Since the @b{2} is vertically positioned next to its note, we have to
meddle with the interface associated with this positioning.  This is
done using @code{side-position-interface}.  The page for this interface 
says

@quotation
@code{side-position-interface}

Position a victim object (this one) next to other objects (the
support).  The property @code{direction} signifies where to put the
victim object relative to the support (left or right, up or down?)
@end quotation

@cindex padding
@noindent
below this description, the variable @code{padding} is described as

@quotation
@table @code
@item padding
(dimension, in staff space)

Add this much extra space between objects that are next to each other. 
@end table
@end quotation

By increasing the value of @code{padding}, we can move away the
fingering.  The following command inserts 3 staff spaces of white
between the note and the fingering:
@example
\once \override Voice.Fingering #'padding = #3
@end example

Inserting this command before the Fingering object is created,
i.e., before @code{c2}, yields the following result:

@lilypond[quote,relative=2,fragment,verbatim]
\once \override Voice.Fingering #'padding = #3
c-2
\stemUp
f
@end lilypond


In this case, the context for this tweak is @context{Voice}.  This
fact can also be deduced from the program reference, for the page for
the @internalsref{Fingering_engraver} plug-in says

@quotation
Fingering_engraver is part of contexts: @dots{} @b{@internalsref{Voice}}
@end quotation

@node Difficult tweaks
@subsection Difficult tweaks

There are two classes of difficult adjustments.  First, when there are
several of the same objects at one point, and you want to adjust only
one.  For example, if you want to change only one note head in a chord.

In this case, the @code{\applyoutput} function must be used.  The
next example defines a Scheme function @code{set-position-font-size}
that sets the @code{font-size} property, but only  
on objects that have @internalsref{note-head-interface} and are at the
right Y-position.

@lilypond[quote,verbatim]
#(define ((set-position-font-size pos size) grob origin current)
  (let*
      ((interfaces (ly:grob-property grob 'interfaces))
       (position (ly:grob-property grob 'staff-position)))
   (if (and
        ; is this a note head?
        (memq 'note-head-interface interfaces)

        ; is the Y coordinate right?
        (= pos position))

      ; then do it.
      (set! (ly:grob-property grob 'font-size) size))))

\relative {
  c
  \applyoutput #(set-position-font-size -2 4)
  <c e g>
}
@end lilypond

@noindent
A similar technique can be used for accidentals.  In that case, the
function should check for @code{accidental-interface}.

Another difficult adjustment is the appearance of spanner objects,
such as slur and tie.  Initially, only one of these objects is created,
and they can be adjusted with the normal mechanism.  However, in some
cases the spanners cross line breaks.  If this happens, these objects
are cloned.  A separate object is created for every system that it is
in.  These are clones of the original object and inherit all
properties, including @code{\override}s.

In other words, an @code{\override} always affects all pieces of a
broken spanner.  To change only one part of a spanner at a line break,
it is necessary to hook into the formatting process.  The
@code{after-line-breaking-callback} property contains the Scheme procedure
that is called after the line breaks have been determined, and layout
objects have been split over different systems.

In the following example, we define a procedure
@code{my-callback}.  This procedure
 
@itemize @bullet
@item
determines if we have been split across line breaks
@item
if yes, retrieves all the split objects
@item
checks if we are the last of the split objects
@item
if yes, it sets @code{extra-offset}.
@end itemize

This procedure is installed into @internalsref{Tie}, so the last part
of the broken tie is translated up.


@lilypond[quote,verbatim,raggedright]
#(define (my-callback grob)
  (let* (
         ; have we been split? 
         (orig (ly:grob-original grob))

         ; if yes, get the split pieces (our siblings)
         (siblings (if (ly:grob? orig)
                     (ly:spanner-broken-into orig) '() )))

   (if (and (>= (length siblings) 2)
             (eq? (car (last-pair siblings)) grob))
     (ly:grob-set-property! grob 'extra-offset '(-2 . 5)))))

\relative c'' { 
  \override Tie #'after-line-breaking-callback =
  #my-callback
  c1 ~ \break c2 ~ c
}
@end lilypond

@noindent
When applying this trick, the new @code{after-line-breaking-callback}
should also call the old @code{after-line-breaking-callback}, if there
is one.  For example, if using this with @code{Slur},
@code{Slur::after_line_breaking} should also be called.

@node Fonts
@section Fonts

This section details the ways that the font can be changed.

@menu
* Selecting font sizes::        
* Font selection::              
@end menu



@node Selecting font sizes
@subsection Selecting font sizes


The easiest method of setting the font size of any context, is by
setting the @code{fontSize} property.

@lilypond[quote,fragment,relative=1,verbatim]
c8
\set fontSize = #-4
c f
\set fontSize = #3
g
@end lilypond

@noindent
It does not change the size of variable symbols, such as beams or
slurs.

Internally, the @code{fontSize} context property will cause the
@code{font-size} property to be set in all layout objects.  The value
of @code{font-size} is a number indicating the size relative to the
standard size for the current staff height.  Each step up is an
increase of approximately 12% of the font size.  Six steps is exactly a
factor two.  The Scheme function @code{magstep} converts a
@code{font-size} number to a scaling factor.

@lilypond[quote,fragment,relative=1,verbatim]
c8
\override NoteHead #'font-size = #-4
c f
\override NoteHead #'font-size = #3
g
@end lilypond

LilyPond has fonts in different design sizes.  The music fonts for
smaller sizes are chubbier, while the text fonts are relatively wider.
Font size changes are achieved by scaling the design size that is
closest to the desired size.  The standard font size (for
@code{font-size} equals 0), depends on the standard staff height.  For
a 20pt staff, a 10pt font is selected.

The @code{font-size} mechanism does not work for fonts selected
through @code{font-name}.  These may be scaled with
@code{font-magnification}.  The @code{font-size} property can only be
set on layout objects that use fonts; these are the ones supporting
the @internalsref{font-interface} layout interface.

@refcommands

The following commands set @code{fontSize} for the current voice:

@cindex @code{\tiny}
@code{\tiny}, 
@cindex @code{\small}
@code{\small}, 
@cindex @code{\normalsize}
@code{\normalsize}.



@cindex magnification
@cindex cue notes


@node Font selection
@subsection Font selection



@cindex font selection
@cindex font magnification
@cindex @code{font-interface}

By setting the object properties described below, you can select a
font from the preconfigured font families.  LilyPond has default
support for the feta music fonts and @TeX{}'s Computer Modern text
fonts.


@itemize @bullet
@item @code{font-encoding}
is a symbol that sets layout of the glyphs.  This should only be set to
select different types of non-text fonts, eg.

@code{fetaBraces} for piano staff braces, @code{fetaMusic} the
standard music font, including ancient glyphs, @code{fetaDynamic} for
dynamic signs and @code{fetaNumber} for the number font.

@item @code{font-family}
is a symbol indicating the general class of the typeface.  Supported are
@code{roman} (Computer Modern), @code{sans}, and @code{typewriter}.
  
@item @code{font-shape}
is a symbol indicating the shape of the font.  There are typically
several font shapes available for each font family.  Choices are
@code{italic}, @code{caps}, and @code{upright}.

@item @code{font-series}
is a symbol indicating the series of the font.  There are typically
several font series for each font family and shape.  Choices are
@code{medium} and @code{bold}. 

@end itemize

Fonts selected in the way sketched above come from a predefined style
sheet.

The font used for printing a object can be selected by setting
@code{font-name}, e.g.,
@example
\override Staff.TimeSignature
    #'font-name = #"cmr17"
@end example

@noindent
Any font can be used, as long as it is available to @TeX{}.  Possible
fonts include foreign fonts or fonts that do not belong to the
Computer Modern font family.  The size of fonts selected in this way
can be changed with the @code{font-magnification} property.  For
example, @code{2.0} blows up all letters by a factor 2 in both
directions.

@cindex font size
@cindex font magnification



@seealso

Init files: @file{ly/@/declarations@/-init@/.ly} contains hints how new
fonts may be added to LilyPond.



@node Text markup
@section Text markup
@cindex text markup
@cindex markup text


@cindex typeset text

The internal mechanism to typeset texts is accessed with the keyword
@code{\markup}.  Within markup mode, you can enter texts similar to
lyrics.  They are simply entered, while commands use the backslash @code{\}.
@cindex markup

@lilypond[quote,verbatim,fragment,relative=1]
c1^\markup { hello }
c1_\markup { hi there }
c1^\markup { hi \bold there, is \italic anyone home? }
@end lilypond

@cindex font switching

The markup in the example demonstrates font switching commands.  The
command @code{\bold} and @code{\italic} apply to the first following 
word only; enclose a set of texts with braces to apply a command
to more words:
@example
\markup @{ \bold @{ hi there @} @}
@end example

@noindent
For clarity, you can also do this for single arguments, e.g.,

@example
\markup @{ is \italic @{ anyone @} home @}
@end example

@cindex font size, texts


In markup mode you can compose expressions, similar to mathematical
expressions, XML documents, and music expressions.  You can stack
expressions grouped vertically with the command @code{\column}.
Similarly, @code{\center-align} aligns texts by their center lines:

@lilypond[quote,verbatim,fragment,relative=1]
c1^\markup { \column { a bbbb \line { c d } } }
c1^\markup { \center-align { a bbbb c } }
c1^\markup { \line { a b c } }
@end lilypond


Markups can be stored in variables and these variables
may be attached to notes, like
@example
allegro = \markup @{ \bold \large @{ Allegro @} @}
 @{ a^\allegro b c d @}
@end example


Some objects have alignment procedures of their own, which cancel out
any effects of alignments applied to their markup arguments as a
whole.  For example, the @internalsref{RehearsalMark} is horizontally
centered, so using @code{\mark \markup @{ \left-align .. @}} has no
effect.

Similarly, for moving whole texts over notes with
@code{\raise}, use the following trick:
@lilypond[quote,verbatim]
{
  c'^\markup { \raise #0.5 not-raised }
  c'^\markup { "" \raise #0.5 raised }
}
@end lilypond

On the second note, the text @code{raised} is moved relative to the
empty string @code{""} which is not visible.  Alternatively, complete
objects can be moved with layout properties such as @code{padding} and
@code{extra-offset}.




@seealso

Init files: @file{scm/@/new@/-markup@/.scm}.


@refbugs

Kerning or generation of ligatures is only done when the @TeX{}
backend is used.  In this case, LilyPond does not account for them so
texts will be spaced slightly too wide.

Syntax errors for markup mode are confusing.


@menu
* Text encoding::               
* Nested scores::               
* Overview of text markup commands::  
* New dynamic marks::           
* Other text markup issues::    
@end menu

@node Text encoding
@subsection Text encoding

LilyPond uses the Pango library to format multi-lingual texts, and
does not perform any input-encoding conversions.  This means that any
text, be it title, lyric text, or musical instruction containing
non-ASCII characters, must be utf-8.  Easiest to enter such texts is
by using a Unicode-aware editor, and save using utf-8 encoding.  Most
popular modern editors have utf-8 support, for example, vim, Emacs,
jEdit, and GEdit do.

Depending on the fonts installed, the following fragment shows Hebrew
and Cyrillic lyrics,

@cindex Cyrillic
@cindex Hebrew
@cindex ASCII, non

@lilypondfile[fontload]{utf8.ly}


The @TeX{} backend does not handle encoding specially at all.  Strings
in the input are put in the output as-is.  Extents of text items in the
@TeX{} backend, are determined by reading a file created via the
@file{texstr} backend,

@example
lilypond -b texstr input/les-nereides.ly
latex les-nereides.texstr
@end example

The last command produces @file{les-nereides.textmetrics}, which is
read when you execute

@example
lilypond -b tex input/les-nereides.ly
@end example

Both @file{les-nereides.texstr} and @file{les-nereides.tex} need
suitable LaTeX wrappers to load appropriate La@TeX{} packages for
interpreting non-ASCII strings.

@seealso

@inputfileref{input/regression,utf8.ly}


@node Nested scores
@subsection Nested scores

It is possible to nest music inside markups, by adding a @code{\score}
block to a markup expression.  Such a score must contain a @code{\layout}
block.

@lilypond[quote,verbatim,raggedright]
\relative {
  c4 d^\markup {
    \score {
      \relative { c4 d e f }
      \layout { }
    }
  }
  e f
}
@end lilypond
 


@node Overview of text markup commands
@subsection Overview of text markup commands

The following commands can all be used inside @code{\markup @{ @}}.

@include markup-commands.tely


@node New dynamic marks
@subsection New dynamic marks

It is possible to print new dynamic marks or text that should be aligned
with dynamics.  Use @code{make-dynamic-script} to create these marks.

@cindex make-dynamic-script

@lilypond[quote,verbatim,raggedright]
sfzp = #(make-dynamic-script "sfzp")
\relative c' {
  c4 c c\sfzp c
}
@end lilypond

@cindex Dynamics, editorial
@cindex Dynamics, parenthesis

It is also possible to print dynamics in round parenthesis or square
brackets.  These are often used for adding editorial dynamics.

@lilypond[quote,verbatim,raggedright]
\version "2.4.2"
rndf = \markup{ \center-align {\line { \bold{\italic (}
  \dynamic f \bold{\italic )} }} }
boxf = \markup{ \bracket { \dynamic f } }
{ c'1_\rndf c'1_\boxf }
@end lilypond


@node Other text markup issues
@subsection Other text markup issues

To use a normal font within a title, you must define it manually

@example
#(def-markup-command (normal-font layout props arg) (markup?)
  "Switch to normal text font"
  (interpret-markup layout (cons '((font-series . 'medium) (font-shape . 'upright)) props) arg))

\header@{
  title = \markup@{ ABCD \normal-font ABCD @}
@}
@end example



