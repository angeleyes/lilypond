# -*-python-*-

import glob
import os

here = os.getcwd ()
reldir = str (Dir ('.').srcnode ())
os.chdir (reldir)
sources = glob.glob ('*.cc') + ['parser.yy', 'lexer.ll']
os.chdir (here)

name = 'lyparser'

Import ('env')
e = env.Copy ()

e.Append (YACCFLAGS = '-d')
outdir = os.path.join (env['build'], reldir, env['out'])
e.Append (CPPPATH = [outdir, '#/lily/include', '#/flower/include'])
e.Depends ('lexer.cc', 'parser.cc')
e.Depends ('my-lily-lexer.o', 'parser.cc')
e.Depends ('my-lily-parser.o', 'parser.cc')

# some stuff here from lily-as-lib
if not os.path.exists ('main.cc'):
	if env['static']:
		e.Library (name, sources) 
	if not env['static'] or env['shared']:
		e.SharedLibrary (name, sources)
else:
	#e.Append (LIBS = ['lygui', 'lyparser', 'lily', 'flower'])
	e.Append (LIBS = ['flower'])
	e.ParseConfig ('guile-config link')
	name = 'lilypond-bin'
	lily = e.Program (name, sources)
	env.Install (env['bindir'], lily)
	env.Alias ('install', env['bindir'])
