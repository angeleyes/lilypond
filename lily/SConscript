# -*-python-*-

import glob
import os

Import ('env')
here = os.getcwd ()
reldir = str (Dir ('.').srcnode ())
os.chdir (reldir)
sources = glob.glob ('*.cc') + ['parser.yy', 'lexer.ll']
includes = glob.glob ('include/*.hh')
os.chdir (here)
outdir = os.path.join (env['build'], reldir, env['out'])

name = 'lyparser'

e = env.Copy ()

#let's do this after the split
#sources = filter (lambda x: x != 'pangofc-afm-decoder.cc', sources)
#pango = env.Copy ()
#if pango['gui']:
#	pango.ParseConfig ('pkg-config --cflags --libs gtk+-2.0')
#	pango.ParseConfig ('pkg-config --cflags --libs pango')
#pango.Object ('foo-' + 'pangofc-afm-decoder.o', 'pangofc-afm-decoder.cc')
#
#e.Object ('pangofc-afm-decoder.o', 'foo-pangofc-afm-deocder.o')

e.Append (YACCFLAGS = '-d')
e.Append (CPPPATH = [outdir, '#/lily/include', '#/flower/include'])
e.Depends ('lexer.cc', 'parser.cc')
e.Depends ('my-lily-lexer.o', 'parser.cc')
e.Depends ('my-lily-parser.o', 'parser.cc')

# some stuff here from lily-as-lib
e.Append (LIBS = ['flower'])
e.ParseConfig ('guile-config link')
name = 'lilypond-bin'
lily = e.Program (name, sources)
env.Install (env['bindir'], lily)
env.Alias ('install', env['bindir'])

env.Alias ('lily', lily)

all_sources = ['SConscript',] + sources + includes
# ballprefix = env['ballprefix'] + '/lily'
# ball = Builder (prefix = ballprefix + '/', action = 'ln $SOURCE $TARGET')
# et = env.Copy (BUILDERS = {'BALL': ball})
# ballize = map (et.BALL, all_sources)
# tar = env.Tar (env['tarball'],
# 	       map (lambda x: os.path.join (ballprefix, x), all_sources))
