#!/bin/sh
#
# project  LilyPond -- the musical typesetter
# title	   (bash/sh/ksh) script to setup library and auto generated files
# file	   bin/configure
#
# Copyright (c) 1997 by    
#	Han-Wen Nienhuys <hanwen@stack.nl>
#   	Jan Nieuwenhuizen <jan@digicash.com>
# 

MAKE=${MAKE:-make}
NEEDFLOWERVER=1.1.6
PREFIX=${PREFIX:-.}


#############
#############

# without "function" ok for ksh, bash
setversion() {
	eval `sed -n 's/^\([A-Z_]*\)[ 	]*=[	 ]*\([^ 	\#]*\).*$/\1=\2/p' $1`
#	NEWVER=$TOPLEVEL_MAJOR_VERSION.$TOPLEVEL_MINOR_VERSION.$TOPLEVEL_PATCH_LEVEL$TOPLEVEL_MY_PATCH_LEVEL
	NEWVER=$MAJOR_VERSION.$MINOR_VERSION.$PATCH_LEVEL$MY_PATCH_LEVEL
	echo
	echo "Current  version ("`pwd`") is:"
	echo "	$NEWVER"
	echo
}

do_outdir() {
	if [ \! -d $1/out ]
	then
		mkdir $1/out
		echo 0 > $1/.build
	fi
}

echo using PREFIX=$PREFIX
echo I need Flower version $NEEDFLOWERVER

flowertar=flower-$NEEDFLOWERVER

#ugh
do_outdir flower/lib
do_outdir Documentation
do_outdir lib
do_outdir lily
do_outdir m2m

# mmm
if [ -x flower ]
then
	echo Found flowerdir
else
	if [ -d $flowertar ]
	then
		ln -fs $flowertar flower
	elif [ -d ../$flowertar ]
	then
		ln -fs ../$flowertar flower
	else
		echo "can't find $flowertar"
		exit 1;
	fi
fi

echo Configuring Flower Library
setversion ./flower/.version
if [ $NEWVER != $NEEDFLOWERVER ]; then
	echo "You seem to be having an incorrect version of the Flower library"
else
	echo "You got the correct Flower version."
fi

#ugh
echo '#define LIBDIR "'$PREFIX'/"'> lib/out/config.hh
touch flower/lib/out/flower-config.hh
touch make/Site.make
$MAKE -C make -f Initial.make

echo "The sources are ready for compiling. "
echo "To make sure that you don't have any stale dependencies: do"
echo "		make clean"

