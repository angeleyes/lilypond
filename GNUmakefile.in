# -*-Makefile-*-
# title	   specific top level makefile for LilyPond  

# subdir level:
#
depth = .
#

# descent order into subdirectories
# 
SUBDIRS = buildscripts python scripts \
	flower lily \
	mf ly tex ps scm \
	po make \
	cygwin debian $(builddir)/stepmake \
	Documentation input
#

SCRIPTS = configure aclocal.m4 autogen.sh
README_FILES =  ChangeLog  COPYING DEDICATION ROADMAP THANKS
README_TXT_FILES = AUTHORS.txt README.txt INSTALL.txt NEWS.txt
IN_FILES := $(wildcard *.in)
EXTRA_DIST_FILES = $(wildcard *.el) VERSION lilypond.vim vimrc  $(README_FILES)  $(SCRIPTS) $(IN_FILES)  emacsclient.patch server.el.patch darwin.patch .cvsignore  lexer-gcc-3.1.sh
NON_ESSENTIAL_DIST_FILES = $(README_TXT_FILES)
INSTALLATION_DIR=$(local_lilypond_datadir)
INSTALLATION_FILES=$(config_make) VERSION

# bootstrap stepmake:
#
STEPMAKE_TEMPLATES=toplevel po install
include $(depth)/make/stepmake.make 

doc: 
	$(MAKE) -C Documentation

pfa-fonts:
	$(MAKE) MAKE_PFA_FILES=1 -C mf
# don't make fontball - we have binary packages for that.

install-pfa-fonts:
	$(MAKE) MAKE_PFA_FILES=1 -C mf install

fontball=type1-$(TOPLEVEL_VERSION).tar.gz
deb=lilypond_$(TOPLEVEL_VERSION)-1_i386.deb
debian-mirror=http://ftp.$(LANG).debian.org

$(outdir)/$(deb):
	wget -P $(outdir) $(debian-mirror)/debian/pool/main/l/lilypond/$(deb)

#lld=.$(local_lilypond_datadir)
lld=./usr/share/lilypond/$(TOPLEVEL_VERSION)
$(outdir)/$(fontball): $(outdir)/$(deb)
	rm -rf $(outdir)/./usr
	ar p $< data.tar.gz | \
		tar -C $(outdir) -zxf - $(lld)/dvips $(lld)/fonts/type1
# strip the $(lld) part?
	tar -C $(outdir) -czf $@ ./usr

get-pfa-fonts: $(outdir)/$(fontball)
	# install by hand from $<

lilypond.words:
	cd $(builddir) && $(PYTHON) $(buildscript-dir)/lilypond.words.py $(outdir)/lilypond.words

web-install: 
	-$(INSTALL) -m 755 -d $(webdir) 
	tar -C $(webdir)/ -xzf $(outdir)/web.tar.gz

local-install:
	$(INSTALL) -d $(local_lilypond_datadir)

final-install:
	@echo
	@echo " *** Before running, buildscripts/out/lilypond-{profile,login}"
	@echo " *** must be run. You're advised to source these scripts from your "
	@echo " *** login scripts. For more information, see Invoking LilyPond in the manual."
	@echo 

web-ext = gz html midi pdf png txt ly

footify = MAILADDRESS=bug-lilypond@gnu.org  $(PYTHON) $(step-bindir)/add-html-footer.py  --name $(PACKAGE_NAME) --version $(TOPLEVEL_VERSION)

bla:
	cd $(builddir) && $(footify) `$(FIND) . -name '*.html' -print`

local-WWW-post:  
	$(PYTHON) $(buildscript-dir)/mutopia-index.py -o $(builddir)/examples.html ./
	cd $(builddir) && $(footify) `$(FIND) . -name '*.html' -print`
	cd $(builddir) && rm -f `find . -name \*.html~ -print`
	cd $(builddir) && find Documentation input \
		$(web-ext:%=-path '*/out-www/*.%' -or) -false \
		> $(outdir)/weblist
	echo '<META HTTP-EQUIV="refresh" content="0;URL=Documentation/out-www/index.html">' > $(builddir)/index.html
	echo '<html><body>Redirecting to the documentation index...</body></html>' >> $(builddir)/index.html
	cd $(builddir) && ls *.html >> $(outdir)/weblist
	cat $(outdir)/weblist | (cd $(builddir); GZIP=-9v tar -czf $(outdir)/web.tar.gz  -T -)


src-ext = c cc yy ll hh icc py scm tex ps texi itexi tely itely sh

ALL-TAGS:
	etags $(shell find . $(src-ext:%=-name '*.%' -or) -false | grep -v '/out')

web-clean:
	$(SHELL) $(buildscript-dir)/clean-fonts.sh
	$(MAKE) out=www clean
	$(MAKE) $(builddir)/share/lilypond-force


default: $(config_h) builddir-setup 

builddir-setup: $(builddir)/share/lilypond-force

PO_FILES = $(wildcard $(srcdir)/po/*.po)
HELP_CATALOGS = $(PO_FILES:$(srcdir)/po/%.po=%)
CATALOGS = $(HELP_CATALOGS:lilypond=) 

$(builddir)/share/lilypond-force:
# Preparing LilyPond tree for builddir exec
	cd $(builddir) && rm -rf lib share
	mkdir -p $(builddir)/lib/lilypond
	mkdir -p $(builddir)/share/lilypond
	mkdir -p $(builddir)/share/lilypond/fonts
	mkdir -p $(builddir)/share/lilypond/tex
	cd $(builddir)/lib/lilypond && \
		ln -s  ../../python/$(outconfbase) python
	cd $(builddir)/share/lilypond && \
		ln -s $(abs-srcdir)/ly ly && \
		ln -s ../../mf/$(outconfbase) dvips && \
		ln -s ../../mf/$(outconfbase) afm && \
		ln -s ../../mf/$(outconfbase) tfm && \
		ln -s $(abs-srcdir)/mf && \
		ln -s $(abs-srcdir)/ps && \
		ln -s ../../python/$(outconfbase) python && \
		ln -s $(abs-srcdir)/scm
	cd $(builddir)/share/lilypond/tex && \
		ln -s $(abs-srcdir)/tex source && \
		ln -s ../../../mf/$(outconfbase) generate
	cd $(builddir)/share/lilypond/fonts && \
		ln -s $(abs-srcdir)/mf source && \
		ln -s ../../../mf/$(outconfbase) afm && \
		ln -s ../../../mf/$(outconfbase) tfm && \
		ln -s ../../../mf/$(outconfbase) type1
	$(foreach i,$(CATALOGS), \
		mkdir -p $(builddir)/share/locale/$i/LC_MESSAGES && \
		cd $(builddir)/share/locale/$i/LC_MESSAGES && \
		ln -fs ../../../../po/$(outconfbase)/$i.mo lilypond.mo &&) true
	touch $@

local-clean: builddir-setup-clean
builddir-setup-clean:
	cd $(builddir) && rm -rf share

$(config_h): configure.in aclocal.m4
#
# this is to prevent people from getting
# undefined symbols  when we add them to config.h.in,
# and they blindly run "cvs update; make".
#
	@echo
	@echo ' *** $(config_h) is out of date'
	@echo ' *** Remove it and rerun autogen:'
	@echo '         rm $(config_h); ./autogen.sh'
	@echo
	@false


# maybe move into private script?
rsync-web:
	cd out-www &&  mkdir web && tar  -xzf web.tar.gz -C web
	cd out-www/web &&  rsync --delete --stats --progress -rltvu -e ssh . x:/var/www/lilypond/doc/v1.9/
	cd out-www && rm -rf web/
