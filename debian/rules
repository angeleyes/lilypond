#!/usr/bin/make -f
# Made with the aid of debhelper by Joey Hess,
# based on the sample debian/rules file for GNU hello by Ian Jackson.
#
# This is free software; see the GNU General Public Licence
# version 2 or later for copying conditions.  There is NO warranty.
#
# Currently maintained by Anthony Fok <foka@debian.org>
# for Debian GNU/Linux.

package = lilypond

SHELL = /bin/sh
r = debian/tmp
TMP = `pwd`/debian/tmp
d = usr/doc/$(package)

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=1

build: build-stamp
build-stamp:
	dh_testdir

	./configure --disable-checking --disable-debugging \
		--enable-printing --prefix=/usr --disable-optimise \
		--enable-shared \
		--infodir='$${prefix}/share/info' \
		--mandir='$${prefix}/share/man'
	$(MAKE) all
	$(MAKE) -C Documentation/pictures pngs

	# Remove the "-" and the "-k" once the \times segfault
	# bug is fixed.  (lilypond-1.1.31, 1999-02-17)
	# -$(MAKE) -k -C Documentation/tex dvi
	-$(MAKE) -C Documentation/tex dvi
	-$(MAKE) -C Documentation info

	# $(MAKE) htmldoc

	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp install-stamp
	-$(MAKE) distclean
	rm -f stepmake/stepmake/aclocal.m4
	dh_clean

	# Correct the owner of the out/dummy.dep files when built with sudo.
	if [ -n "$$SUDO_USER" -a -n "$$SUDO_GID" ]; then \
		find . -user root | xargs -r chown --dereference $$SUDO_USER.$$SUDO_GID; \
	fi

install: install-stamp
install-stamp: build-stamp
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs usr/doc/texmf \
		usr/lib/emacs/site-lisp \
		usr/doc/$(package)/examples \
		usr/share/texmf/tex \
		usr/share/texmf/fonts/source/public \
		usr/share/texmf/fonts/afm/public \
		usr/share/texmf/fonts/tfm/public
	ln -fs ../lilypond $(r)/usr/doc/texmf/lilypond

	$(MAKE) prefix=$(TMP)/usr install

	ln -s ../../lilypond/tex $(r)/usr/share/texmf/tex/lilypond
	ln -s ../../../../lilypond/mf $(r)/usr/share/texmf/fonts/source/public/lilypond
	ln -s ../../../../lilypond/afm $(r)/usr/share/texmf/fonts/afm/public/lilypond
	ln -s ../../../../lilypond/tfm $(r)/usr/share/texmf/fonts/tfm/public/lilypond

	touch install-stamp

# Build architecture-independent files here.
binary-indep: build install
# We have nothing to do by default.

binary-arch: build install
	dh_testdir
	dh_testroot
	cp -av mudela-mode.el $(r)/usr/lib/emacs/site-lisp
	dh_installdocs AIMS ANNOUNCE* NEWS-* DEDICATION \
		BUGS TASKS TODO *.txt \
		Documentation/pictures/out/*.png \
		Documentation/out/*.txt \
		Documentation/tex/*.doc \
		Documentation/tex/*.bib \
		Documentation/tex/out/*.dvi
#	dh_installexamples input
	cp -aP `find input mutopia \( -name '*.ly' -o -name '*.tex' -o -name 'TODO' \)` \
		$(r)/$(d)/examples
	for i in `find $(r)/$(d)/examples/ -type d -name out`; do \
		mv -fv $$i/* $$i/..; rmdir $$i; done
#	dh_installmenu
#	dh_installemacsen
#	dh_installcron
#	dh_installmanpages
#	dh_undocumented
	dh_installchangelogs -k NEWS
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
	dh_suidregister
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
#	dh_makeshlibs
	dh_md5sums
	dh_builddeb

source diff:
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

binary: binary-indep binary-arch
.PHONY: build clean install binary-indep binary-arch binary
